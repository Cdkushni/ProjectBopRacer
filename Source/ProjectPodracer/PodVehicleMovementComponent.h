// This header defines our custom movement component for the PodVehicle.
// It handles applying movement and steering forces, and integrates with network prediction.

#pragma once

#include "CoreMinimal.h"
#include "GameFramework/PawnMovementComponent.h"
#include "PodVehicleMovementComponent.generated.h"

class APodVehicle;

// Define a struct to hold client move data for prediction and reconciliation
USTRUCT()
struct FClientMoveData
{
	GENERATED_BODY()

	// Input values
	UPROPERTY()
	float MoveForwardInput;
	UPROPERTY()
	float TurnRightInput;
	UPROPERTY()
	bool bIsBoosting;
	UPROPERTY()
	bool bIsBraking;
	UPROPERTY()
	bool bIsDrifting;

	// Unique ID for this move, used for reconciliation
	UPROPERTY()
	uint32 MoveID;

	// DeltaTime that the client used for this move's prediction
	UPROPERTY()
	float DeltaTime; 

	FClientMoveData() 
		: MoveForwardInput(0.0f), TurnRightInput(0.0f), bIsBoosting(false), bIsBraking(false), bIsDrifting(false), MoveID(0), DeltaTime(0.0f) {}
	FClientMoveData(float InForward, float InTurn, bool InBoosting, bool InBraking, bool InDrifting, uint32 InID, float InDeltaTime)
		: MoveForwardInput(InForward), TurnRightInput(InTurn), bIsBoosting(InBoosting), bIsBraking(InBraking), bIsDrifting(InDrifting), MoveID(InID), DeltaTime(InDeltaTime) {}

	// For TArray::RemoveSingle, needed to compare moves
	bool operator==(const FClientMoveData& Other) const
	{
		return MoveID == Other.MoveID;
	}
};

/**
 * Custom movement component for the PodVehicle, handling high-speed arcade physics
 * and network replication for smooth multiplayer gameplay.
 */
UCLASS()
class PROJECTPODRACER_API UPodVehicleMovementComponent : public UPawnMovementComponent
{
	GENERATED_BODY()

public:
	UPodVehicleMovementComponent();
	
	virtual void BeginPlay() override;

	// Overrides from UPawnMovementComponent
	// This is where the core movement logic for the vehicle will live.
	virtual void TickComponent(float DeltaTime, ELevelTick TickType, FActorComponentTickFunction* ThisTickFunction) override;

	// --- Input State ---
	// Stores the current desired forward movement input (e.g., from W/S keys or joystick).
	// Value is typically between -1.0 (backward) and 1.0 (forward).
	UPROPERTY(Transient, Replicated) // Transient: Not saved. Replicated: Sent over network.
	float MoveForwardInput;
	// Stores the current desired turning input (e.g., from A/D keys or joystick).
	// Value is typically between -1.0 (left) and 1.0 (right).
	UPROPERTY(Transient, Replicated)
	float TurnRightInput;
	// Is the boost button currently held?
	UPROPERTY(Transient, Replicated)
	bool bIsBoosting;
	// Is the brake button currently held?
	UPROPERTY(Transient, Replicated)
	bool bIsBraking;
	// Is the drift button currently held?
	UPROPERTY(Transient, Replicated)
	bool bIsDrifting;

	// --- Replicated Angular State ---
	// Current angular velocity around the Yaw axis. Replicated for simulated proxies.
	UPROPERTY(Transient, Replicated)
	float CurrentAngularYawVelocity;

	// Setter for MoveForwardInput, used by the owning PodVehicle.
	void SetMoveForwardInput(float Value);
	// Setter for TurnRightInput, used by the owning PodVehicle.
	void SetTurnRightInput(float Value);
	// Setter for bIsBoosting.
	void SetBoostInput(bool bNewState);
	// Setter for bIsBraking.
	void SetBrakeInput(bool bNewState);
	// Setter for bIsDrifting.
	void SetDriftInput(bool bNewState);

	// --- Server RPCs for Client Input ---
	// This RPC is called by the client to send its MoveForward input to the server.
	UFUNCTION(Server, Unreliable) // Unreliable for frequent input, client will resend if needed
	void Server_ProcessMove(FClientMoveData ClientMove);
	// No _Implementation for RPCs here, generated by UHT.

	// --- Client RPC for Server Acknowledgment ---
	// This RPC is called by the server to send authoritative state back to the owning client.
	UFUNCTION(Client, Reliable)
	void Client_AcknowledgeMove(uint32 LastProcessedMoveID, FVector ServerLocation, FRotator ServerRotation, FVector ServerVelocity, float ServerAngularYawVelocity);


	// --- Vehicle Physics Parameters ---
	// Max linear speed (cm/s)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement")
	float MaxSpeed;
	// Linear acceleration rate (cm/s^2)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement")
	float Acceleration;
	// Deceleration rate when no forward input is applied (cm/s^2)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement")
	float Deceleration;
	// Linear damping (0-1, 1 means instant stop)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement")
	float LinearDamping;
	// Rate at which the pod can turn (degrees per second).
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement")
	float TurnSpeed;
	// Max target angular velocity for turning (degrees/s)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Steering")
	float MaxTurnRate;
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Vehicle")
	float MaxSteeringAngle = 45.0f; // Max steering angle in degrees (PI/4 radians in p5.js)
	// Angular acceleration for turning (degrees/s^2)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Steering")
	float TurnAcceleration;
	// Angular damping for turning (0-1, 1 means instant stop)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Steering")
	float AngularDamping;
	// Multiplier for steering at MaxSpeed (0 to 1, lower = less turn)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Steering")
	float HighSpeedSteeringDampFactor;
	// Speed for interpolating keyboard input to smoothed input
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Steering")
	float KeyboardSteeringInterpSpeed;
	// Speed for returning smoothed input to 0
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Steering")
	float KeyboardSteeringReturnSpeed;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Vehicle")
	float Friction = 0.99f; // Friction coefficient (0.95 to 1 in p5.js)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Vehicle")
	bool bPowerSteering = true; // Auto-recenter steering (like powerSteering in p5.js)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Vehicle")
	bool bAlignToGround = true; // Project movement onto ground plane

	// Boost related parameters
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Boost")
	float BoostAcceleration; // Additional acceleration when boosting (cm/s^2)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Boost")
	float BoostMaxSpeedMultiplier; // Max speed multiplier when boosting

	// Brake related parameters
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Brake")
	float BrakeDeceleration; // Deceleration rate when braking (cm/s^2)

	// Drift related parameters
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Drift")
	float DriftTurnSpeedMultiplier; // How much turn speed is multiplied when drifting
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Drift")
	float DriftLinearDampingMultiplier; // Multiplier for linear damping when drifting (lower = more slide)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Drift")
	float DriftAngularDampingMultiplier; // Multiplier for angular damping when drifting (lower = sustains spin more)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Drift")
	float DriftLateralSlideFactor; // How much lateral velocity is retained when drifting (0-1, 1 means no lateral friction)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Drift")
	float DriftOriginalVelocityBlend; // Blend factor for original direction (0.0 = no original velocity, 1.0 = full original velocity)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Drift")
	float DriftLateralVelocityScale; // Scale for lateral drift velocity (tune for slide strength)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Drift")
	float DriftBlendDecayRate; // Decay original blend per second (0.85 to 0.0 over ~2s)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Drift")
	float DriftMinSlideFactor; // Minimum slide factor for indefinite drift
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Drift")
	float DriftSidewaysTorque; // Sideways velocity magnitude (cm/s)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Drift")
	float DriftMomentumDecayRate; // New: How quickly the lateral momentum decays during drift (lower = longer slide)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Drift")
	float DriftLateralContributionScale; // New: Scales how much CurrentLateralMomentum adds to OutVelocity
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Drift")
	float DriftLateralMomentumMax; // New: Maximum magnitude for CurrentLateralMomentum

	// New drift parameters
	float DriftWheelbase = 150.0f; // Vehicle length (cm), like car.d
	float DriftWidth = 80.0f; // Vehicle width (cm), like car.w
	float DriftMaxWheelAngle = PI / 4.0f; // Max front wheel angle (radians, ±45°)
	float DriftIntensity = 1.0f; // Scales drift factor, like params.drift
	float DriftFriction = 0.99f; // Momentum decay, like params.friction
	float DriftMomentumScale = 0.2f; // Momentum accumulation rate
	float DriftSpeedFriction = 0.995f; // Speed decay during drift

	// Air control parameters
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|AirControl")
	float AirControlTurnFactor; // How much TurnRightInput affects Yaw when airborne
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|AirControl")
	float AirControlPitchFactor; // How much Forward/Backward input affects Pitch when airborne (e.g. for tilting)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|AirControl")
	float AirControlRollFactor; // How much TurnRightInput affects Roll when airborne

	// Air Resistance
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodRacer|Movement")
	float DragCoefficient; // Interpolation speed for air resistance

	// Ground detection parameters
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|GroundDetection")
	float GroundTraceDistance; // How far down to trace for ground
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|GroundDetection")
	float GroundDetectionRadius; // Radius for ground detection trace
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|GroundDetection")
	TEnumAsByte<ECollisionChannel> GroundCollisionChannel; // Collision channel for ground trace

	// Threshold for position difference before a client correction occurs (e.g., in cm)
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement|Networking")
	float CorrectionThreshold;

	// Gravity applied when airborne
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement")
	float GravityScale;

	// Visual Configuration

	// Max angle of engine turn roll rotation
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "PodMovement")
	float AngleOfRoll;

	UPROPERTY()
	APodVehicle* OwningPodVehicle;

	// --- Network Replication ---
	virtual void GetLifetimeReplicatedProps(TArray<FLifetimeProperty>& OutLifetimeProps) const override;

protected:
	// A counter for unique move IDs for client prediction.
	uint32 CurrentMoveID;

	// History of client-side moves for reconciliation.
	TArray<FClientMoveData> ClientMoveHistory;
	
	// Smoothed rudder input for smoother steering, particularly for keyboard.
	float SmoothedRudderInput;

	FVector CurrentVelocity = FVector::ZeroVector;
	FVector GroundNormal = FVector::UpVector;

	// Vehicle state
	float SteeringAngle = 0.0f; // Current steering angle (phi in p5.js, radians)
	//float Speed = 100.0f; // Current speed (cm/s, equivalent to speed * 100)
	FVector Momentum = FVector::ZeroVector; // Lateral momentum for drifting
	float DriftWheelAngle = 0.0f; // Current front wheel angle (radians)

	// New variables for tracking drift state
	bool bIsDriftingLastFrame = false; // Track if we were drifting last frame
	FVector DriftOriginalVelocity = FVector::ZeroVector; // Store forward vector at drift start
	float DriftDuration = 0.0f; // Track time since drift started
	UPROPERTY(Transient, Replicated)
	FVector CurrentLateralMomentum = FVector::ZeroVector; // New: For Mario Kart style sustained sideways drift

	float VehicleLength = 300.0f; // Distance between Engines and Pod (cm)
	float VehicleWidth = 150.0f; // Width between Engines (cm)

	float MomentumScale = 1.0f;
	float DriftFactor = 1.0f;


	// Helper function to apply movement logic for a given input.
	// This function will be called on the client for prediction and replay, and on the server for authority.
	void ApplyMovementLogic(float InMoveForwardInput, float InTurnRightInput, bool InIsBoosting, bool InIsBraking, bool InIsDrifting, float InDeltaTime, FVector& OutVelocity, FRotator& OutRotation, float& OutAngularYawVelocity);

	FHitResult HoverLineTrace(FVector StartLocation, float TraceDistance, FCollisionQueryParams QueryParams);
	FVector HoverLineTraceNormal(FVector StartLocation, float TraceDistance, FCollisionQueryParams QueryParams);
	void AdjustVehiclePitch(float DeltaTime);
	void HandleEngineHoveringVisuals(float InTurnRightInput, float DeltaTime);
	
	// Ground detection
	bool IsGrounded() const;
};